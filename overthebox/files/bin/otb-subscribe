#!/bin/sh
# shellcheck disable=SC1091
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

set -e

. /lib/overthebox

otb_info "Subscribing to the overthebox service..."

_get_private_ips() {
	. /lib/functions/network.sh
	lan_ip=
	network_get_ipaddr lan_ip lan
	# shellcheck disable=SC2016
	jq -n -c --arg lan_ip "$lan_ip" '{private_ips: [$lan_ip]}'
}

_get_private_ips | otb_call POST subscribe -d@- | jq -r '"
set overthebox.me=config
set overthebox.me.device_id=\(.device_id)
set overthebox.me.token=\(.token)
commit overthebox
"' | uci -q batch
