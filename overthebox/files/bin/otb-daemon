#!/bin/sh
# shellcheck disable=SC1090,SC1091
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

. /lib/overthebox

otb_save_event start
otb_todo refresh otb-action-refreshProperties </dev/null

_run() {
	otb_reload
	otb-check-config

	if [ -z "$OTB_DEVICE_ID" ]; then
		otb-subscribe
		otb_reload
	fi

	# Handle todos
	for file in "$OTB_TODO_DIR"/*; do
		[ -f "$file" ] && (. "$file") && rm -f "$file"
	done

	ret=$(otb_device_get actions --dump-header "$OTB_HEADERS_FILE") || return
	read -r LINE < "$OTB_HEADERS_FILE"
	case "$LINE" in
		HTTP*401*)
			otb_err "Got 401"
			# Resubscribe if we don't have a service ID
			# We shouldn't have to check that, but you never know,
			# because resubscribing a device already linked to
			# service would break it irrevocably
			[ -z "$OTB_SERVICE_ID" ] && otb-subscribe
			return
			;;
		HTTP*200*) ;;
		*) return ;;
	esac

	action=$(otb_json_get "$ret" action)
	id=$(otb_json_get "$ret" id)
	otb_debug "Got action '$action' with id '$id'"
	[ -z "$action" ] || [ "$action" = "null" ] && return

	details=$(otb-action-"$action" "$ret" 2>&1) && status="done" || status="error"
	otb_debug "Got status '$status' for action '$action'"
	[ -z "$id" ] || [ "$id" = "null" ] && return

	jq -c -n --arg status "$status" --arg details "$details" \
		'{status: $status, details: $details}' | otb_device_post "actions/$id" -d@-
}

RUNNING=1
trap 'RUNNING=' INT QUIT TERM

while [ "$RUNNING" ]; do
	sleep 1
	_run
done
