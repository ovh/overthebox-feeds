#!/bin/sh
# shellcheck disable=SC1090,SC1091
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

otb-subscribe || exit

. /lib/overthebox

otb_info "Ready for some action!"
export OTB_DEVICE_ID OTB_TOKEN OTB_DEBUG OTB_SERVICE_ID

otb_save_event start

# This code is really bad and should be removed as soons as possible
id=$(uci -q get overthebox.me.action_id)

if [ -n "$id" ]; then
	otb_todo otb_device_post "actions/$id" -d@- <<-EOF
	{"status":"done"}
	EOF
	uci -q batch <<-EOF
	delete overthebox.me.action_id
	commit overthebox
	EOF
fi

while true; do
	reload_config

	# todo
	for file in "$OTB_TODO_DIR"/*; do
		[ -f "$file" ] && (. "$file") && rm -f "$file"
	done

	ret=$(otb_device_get actions)
	[ -z "$ret" ] && exit

	action=$(otb_json_get "$ret" action)
	id=$(otb_json_get "$ret" id)
	otb_debug "Got action '$action' with id '$id'"
	[ -z "$action" ] || [ "$action" = "null" ] && exit

	details=$(otb-action-"$action" "$ret" 2>&1) && status="done" || status="error"
	otb_debug "Got status '$status' for action '$action'"
	[ -z "$id" ] || [ "$id" = "null" ] && continue

	# shellcheck disable=SC2016
	jq -c -n --arg status "$status" --arg details "$details" \
		'{status: $status, details: $details}' | otb_device_post "actions/$id" -d@-

	otb_debug "All done for action '$action'"
done
