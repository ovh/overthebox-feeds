#!/bin/sh
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

set -e

# shellcheck disable=SC1091
. /lib/overthebox

config=$(otb_device_get config)

cat > /tmp/config <<EOF
$config
EOF

_get() {
    otb_json_get "$config" "$1"
}

CONFIG_FILES="
    /etc/config/system
    /etc/config/graph
    /etc/config/glorytun
"
for file in $CONFIG_FILES; do
    [ -f "$file" ] || touch "$file"
done

dev=$(_get glorytun_mud_conf.dev)

uci -q batch << EOF
set glorytun.$dev=mud
set glorytun.$dev.enable=1
set glorytun.$dev.dev=$dev
set glorytun.$dev.server=$(_get glorytun_mud_conf.server)
set glorytun.$dev.port=$(_get glorytun_mud_conf.port)
set glorytun.$dev.key=$(_get glorytun_mud_conf.key)
set glorytun.$dev.mtu=$(_get glorytun_mud_conf.mtu)

set network.$dev=interface
set network.$dev.ifname=$dev
set network.$dev.proto=static
set network.$dev.ipaddr=$(_get glorytun_mud_conf.ip_local)
set network.$dev.netmask=255.255.255.0
set network.$dev.gateway=$(_get glorytun_mud_conf.ip_peer)
set network.$dev.metric=$(_get glorytun_mud_conf.metric)
set network.$dev.txqueuelen=1000
set network.$dev.type=tunnel
set network.$dev.multipath=off

set shadowsocks.proxy=client
set shadowsocks.proxy.server=$(_get shadow_conf.server)
set shadowsocks.proxy.port=$(_get shadow_conf.port)
set shadowsocks.proxy.lport=$(_get shadow_conf.lport)
set shadowsocks.proxy.method=$(_get shadow_conf.method)
set shadowsocks.proxy.timeout=$(_get shadow_conf.timeout)
set shadowsocks.proxy.reuse_port=$(_get shadow_conf.reuse_port)
set shadowsocks.proxy.fast_open=$(_get shadow_conf.fast_open)
set shadowsocks.proxy.disable_sni=$(_get shadow_conf.disable_sni)
set shadowsocks.proxy.monitoring_ip=$(_get shadow_conf.monitoring_ip)
set shadowsocks.proxy.track_interval=$(_get shadow_conf.track_interval)
set shadowsocks.proxy.track_timeout=$(_get shadow_conf.track_timeout)
set shadowsocks.proxy.track_retry=$(_get shadow_conf.track_retry)
set shadowsocks.proxy.password=$(_get shadow_conf.password)

set system.@system[0].log_ip=$(_get log_conf.host)
set system.@system[0].log_port=$(_get log_conf.port)
set system.@system[0].log_proto=$(_get log_conf.protocol)
set system.@system[0].log_prefix=$(_get log_conf.key)

set graph.opentsdb=opentsdb
set graph.opentsdb.url=$(_get graph_conf.host)
set graph.opentsdb.freq=$(_get graph_conf.write_frequency)

commit
EOF

# not here..
[ -d /var/run/config.check ] || reload_config
