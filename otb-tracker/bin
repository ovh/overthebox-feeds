#!/bin/sh
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

# shellcheck disable=SC1091
. /lib/overthebox

while true; do
	glorytun sync dev tun0
	sleep 1

	glorytun path dev tun0 2>/dev/null | (
		ACTION=down

		while read -r _ _ STATUS IP _ PUBIP _; do
			[ "$STATUS" = "OK" ] && ACTION=up

			[ "$PUBIP" ] || continue
			[ "$PUBIP" = "-" ] && continue

			PUBIP_OLD=$(otb_get_data "$IP/pubip")
			[ "$PUBIP" = "$PUBIP_OLD" ] && continue

			otb_set_data "$IP/pubip" "$PUBIP"

			asn="$(curl --max-time 2 --silent --show-error "api.iptoasn.com/v1/as/ip/$PUBIP")"
			[ "$asn" ] && otb_set_data "$IP/asn" "$asn"
		done

		ubus -S call network.interface.tun0 "$ACTION"
	)
	sleep 4
done
