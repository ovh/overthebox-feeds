#!/bin/sh
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

# shellcheck disable=SC1091
. /lib/overthebox

while true; do
	glorytun path dev tun0 2>/dev/null | (
		ACTION=down

		while read -r _ _ STATUS IP _ PUBIP _; do
			[ "$STATUS" = "OK" ] && ACTION=up

			[ "$PUBIP" ] || continue
			[ "$PUBIP" = "-" ] && continue

			PUBIP_OLD=$(otb_get_data "$IP/pubip")
			[ "$PUBIP" = "$PUBIP_OLD" ] && continue

			otb_set_data "$IP/pubip" "$PUBIP"

			asn="$(curl --max-time 2 --silent --show-error "api.iptoasn.com/v1/as/ip/$PUBIP")"
			[ "$asn" ] && otb_set_data "$IP/asn" "$asn"
		done

		ubus -S call network.interface.tun0 "$ACTION"

		service_led="off"
		connectivity_led="off"
		if [ "$ACTION" = "up" ]; then
			connectivity_led="on"
			case "$(ip -o route get 1.1.1.1)" in
				*"dev tun0 table"*) service_led="on" ;;
			esac
		else
			ping -w 3 -c 1 1.1.1.1 >/dev/null 2>/dev/null && connectivity_led="on"
		fi
		otb_led "service" "$service_led"
		otb_led "connectivity" "$connectivity_led"
	)
	sleep 5
done
